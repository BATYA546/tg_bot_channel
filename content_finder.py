# content_finder.py
import logging
import requests
from datetime import datetime
import random

logger = logging.getLogger(__name__)

class ContentFinder:
    def __init__(self):
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
        })
        
        # –¢–û–õ–¨–ö–û –ü–†–û–í–ï–†–ï–ù–ù–´–ï —Ä–∞–±–æ—á–∏–µ —Å—Å—ã–ª–∫–∏ Wikimedia
        self.working_wikimedia_images = [
            'https://upload.wikimedia.org/wikipedia/commons/thumb/6/6c/ENIAC_Penn1.jpg/500px-ENIAC_Penn1.jpg',
            'https://upload.wikimedia.org/wikipedia/commons/thumb/1/10/Alexander_Graham_Bell.jpg/500px-Alexander_Graham_Bell.jpg',
            'https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/First_flight2.jpg/500px-First_flight2.jpg',
            'https://upload.wikimedia.org/wikipedia/commons/thumb/3/3c/Sputnik_1.jpg/500px-Sputnik_1.jpg'
        ]
        
        # Fallback –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å Unsplash (–≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —Ä–∞–±–æ—Ç–∞—é—Ç)
        self.unsplash_images = {
            'space': 'https://images.unsplash.com/photo-1446776653964-20c1d3a81b06?w=500&fit=crop',
            'technology': 'https://images.unsplash.com/photo-1518709268805-4e9042af2176?w=500&fit=crop',
            'aviation': 'https://images.unsplash.com/photo-1436491865332-7a61a109cc05?w=500&fit=crop',
            'computers': 'https://images.unsplash.com/photo-1517077304055-6e89abbf09b0?w=500&fit=crop',
            'default': 'https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=500&fit=crop'
        }

    def search_content(self, max_posts=2):
        """–û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –ø–æ–∏—Å–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞"""
        logger.info("üîç –ù–∞—á–∏–Ω–∞—é –ø–æ–∏—Å–∫ –∫–æ–Ω—Ç–µ–Ω—Ç–∞...")
        
        found_content = []
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç —Å –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–û —Ä–∞–±–æ—Ç–∞—é—â–∏–º–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
        quality_content = self.generate_quality_content_with_images()
        found_content.extend(quality_content)
        
        logger.info(f"üéØ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤: {len(found_content)}")
        return found_content[:max_posts]

    def generate_quality_content_with_images(self):
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç —Å —Ä–∞–±–æ—Ç–∞—é—â–∏–º–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏"""
        quality_posts = [
            {
                'title': '–ü–µ—Ä–≤—ã–π –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–ø—É—Ç–Ω–∏–∫ –ó–µ–º–ª–∏',
                'summary': "üõ∞Ô∏è –ü–ï–†–í–´–ô –ò–°–ö–£–°–°–¢–í–ï–ù–ù–´–ô –°–ü–£–¢–ù–ò–ö –ó–ï–ú–õ–ò\n\n4 –æ–∫—Ç—è–±—Ä—è 1957 –≥–æ–¥–∞ —Å –∫–æ—Å–º–æ–¥—Ä–æ–º–∞ –ë–∞–π–∫–æ–Ω—É—Ä –±—ã–ª –∑–∞–ø—É—â–µ–Ω ¬´–°–ø—É—Ç–Ω–∏–∫-1¬ª ‚Äî –ø–µ—Ä–≤—ã–π –≤ –º–∏—Ä–µ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–ø—É—Ç–Ω–∏–∫ –ó–µ–º–ª–∏. –≠—Ç–æ —Å–æ–±—ã—Ç–∏–µ –ø–æ–ª–æ–∂–∏–ª–æ –Ω–∞—á–∞–ª–æ –∫–æ—Å–º–∏—á–µ—Å–∫–æ–π —ç—Ä–µ —á–µ–ª–æ–≤–µ—á–µ—Å—Ç–≤–∞.\n\n‚Ä¢ –î–∞—Ç–∞: 4 –æ–∫—Ç—è–±—Ä—è 1957 –≥–æ–¥–∞\n‚Ä¢ –°—Ç—Ä–∞–Ω–∞: –°–°–°–†\n‚Ä¢ –ú–∞—Å—Å–∞: 83,6 –∫–≥\n‚Ä¢ –ü–µ—Ä–∏–æ–¥ –æ–±—Ä–∞—â–µ–Ω–∏—è: 96,2 –º–∏–Ω—É—Ç—ã\n\nüåü –ó–∞–ø—É—Å–∫ –ø–µ—Ä–≤–æ–≥–æ —Å–ø—É—Ç–Ω–∏–∫–∞ –¥–æ–∫–∞–∑–∞–ª –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ—Å–º–∏—á–µ—Å–∫–∏—Ö –∞–ø–ø–∞—Ä–∞—Ç–æ–≤ –∏ –æ—Ç–∫—Ä—ã–ª –¥–æ—Ä–æ–≥—É –¥–ª—è –ø–∏–ª–æ—Ç–∏—Ä—É–µ–º–æ–π –∫–æ—Å–º–æ–Ω–∞–≤—Ç–∏–∫–∏. –≠—Ç–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Å—Ç–∞–ª–æ —Å–∏–º–≤–æ–ª–æ–º –Ω–∞—É—á–Ω–æ-—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏ –≤–¥–æ—Ö–Ω–æ–≤–∏–ª–æ —Ü–µ–ª–æ–µ –ø–æ–∫–æ–ª–µ–Ω–∏–µ —É—á–µ–Ω—ã—Ö –∏ –∏–Ω–∂–µ–Ω–µ—Ä–æ–≤.\n\n#–∫–æ—Å–º–æ—Å #—Å–ø—É—Ç–Ω–∏–∫ #–ø–µ—Ä–≤—ã–π #–°–°–°–† #–∏—Å—Ç–æ—Ä–∏—è",
                'category': 'space',
                'url': '',
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—É—é —Å—Å—ã–ª–∫—É –ò–õ–ò fallback
                'image_url': self.get_reliable_image_url('space'),
                'found_date': datetime.now()
            },
            {
                'title': '–ò–∑–æ–±—Ä–µ—Ç–µ–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞',
                'summary': "üìû –ò–ó–û–ë–†–ï–¢–ï–ù–ò–ï –¢–ï–õ–ï–§–û–ù–ê\n\n14 —Ñ–µ–≤—Ä–∞–ª—è 1876 –≥–æ–¥–∞ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ë–µ–ª–ª –ø–æ–¥–∞–ª –∑–∞—è–≤–∫—É –Ω–∞ –ø–∞—Ç–µ–Ω—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, –∫–æ—Ç–æ—Ä–æ–µ –Ω–∞–∑–≤–∞–ª ¬´—Ç–µ–ª–µ—Ñ–æ–Ω¬ª. –≠—Ç–æ –∏–∑–æ–±—Ä–µ—Ç–µ–Ω–∏–µ –Ω–∞–≤—Å–µ–≥–¥–∞ –∏–∑–º–µ–Ω–∏–ª–æ —Å–ø–æ—Å–æ–±—ã –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ –º–µ–∂–¥—É –ª—é–¥—å–º–∏.\n\n‚Ä¢ –ò–∑–æ–±—Ä–µ—Ç–∞—Ç–µ–ª—å: –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ë–µ–ª–ª\n‚Ä¢ –î–∞—Ç–∞ –ø–∞—Ç–µ–Ω—Ç–∞: 7 –º–∞—Ä—Ç–∞ 1876 –≥–æ–¥–∞\n‚Ä¢ –ü–µ—Ä–≤—ã–µ —Å–ª–æ–≤–∞: ¬´–ú–∏—Å—Ç–µ—Ä –í–∞—Ç—Å–æ–Ω, –∏–¥–∏—Ç–µ —Å—é–¥–∞. –í—ã –º–Ω–µ –Ω—É–∂–Ω—ã¬ª\n\nüí° –¢–µ–ª–µ—Ñ–æ–Ω —Å—Ç–∞–ª –ø–µ—Ä–≤—ã–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º, –ø–æ–∑–≤–æ–ª–∏–≤—à–∏–º –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —á–µ–ª–æ–≤–µ—á–µ—Å–∫—É—é —Ä–µ—á—å –Ω–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ. –ó–∞ –ø–µ—Ä–≤—ã–µ 10 –ª–µ—Ç –±—ã–ª–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –±–æ–ª–µ–µ 100 000 –∞–ø–ø–∞—Ä–∞—Ç–æ–≤, —á—Ç–æ —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤—É–µ—Ç –æ —Ä–µ–≤–æ–ª—é—Ü–∏–æ–Ω–Ω–æ—Å—Ç–∏ —ç—Ç–æ–≥–æ –∏–∑–æ–±—Ä–µ—Ç–µ–Ω–∏—è.\n\n#—Ç–µ–ª–µ—Ñ–æ–Ω #–∏–∑–æ–±—Ä–µ—Ç–µ–Ω–∏–µ #–ë–µ–ª–ª #–∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è #–∏—Å—Ç–æ—Ä–∏—è",
                'category': 'technology',
                'url': '',
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—É—é —Å—Å—ã–ª–∫—É –ò–õ–ò fallback
                'image_url': self.get_reliable_image_url('technology'),
                'found_date': datetime.now()
            },
            {
                'title': '–ü–µ—Ä–≤—ã–π –ø–æ–ª–µ—Ç –±—Ä–∞—Ç—å–µ–≤ –†–∞–π—Ç',
                'summary': "‚úàÔ∏è –ü–ï–†–í–´–ô –£–ü–†–ê–í–õ–Ø–ï–ú–´–ô –ü–û–õ–ï–¢\n\n17 –¥–µ–∫–∞–±—Ä—è 1903 –≥–æ–¥–∞ –±—Ä–∞—Ç—å—è –†–∞–π—Ç —Å–æ–≤–µ—Ä—à–∏–ª–∏ –ø–µ—Ä–≤—ã–π –≤ –º–∏—Ä–µ —É–ø—Ä–∞–≤–ª—è–µ–º—ã–π –ø–æ–ª–µ—Ç –Ω–∞ —Å–∞–º–æ–ª–µ—Ç–µ ¬´–§–ª–∞–π–µ—Ä-1¬ª. –≠—Ç–æ —Å–æ–±—ã—Ç–∏–µ –æ—Ç–∫—Ä—ã–ª–æ —ç—Ä—É –∞–≤–∏–∞—Ü–∏–∏.\n\n‚Ä¢ –î–∞—Ç–∞: 17 –¥–µ–∫–∞–±—Ä—è 1903 –≥–æ–¥–∞\n‚Ä¢ –ú–µ—Å—Ç–æ: –ö–∏—Ç—Ç–∏ –•–æ–∫, –°–µ–≤–µ—Ä–Ω–∞—è –ö–∞—Ä–æ–ª–∏–Ω–∞\n‚Ä¢ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–ª–µ—Ç–∞: 12 —Å–µ–∫—É–Ω–¥\n‚Ä¢ –î–∏—Å—Ç–∞–Ω—Ü–∏—è: 36,5 –º–µ—Ç—Ä–æ–≤\n\nüöÄ –ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —Å–∫—Ä–æ–º–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –ø–µ—Ä–≤–æ–≥–æ –ø–æ–ª–µ—Ç–∞, –æ–Ω –¥–æ–∫–∞–∑–∞–ª –ø—Ä–∏–Ω—Ü–∏–ø–∏–∞–ª—å–Ω—É—é –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É–ø—Ä–∞–≤–ª—è–µ–º–æ–≥–æ –ø–æ–ª–µ—Ç–∞ —Ç—è–∂–µ–ª–µ–µ –≤–æ–∑–¥—É—Ö–∞. –í—Å–µ–≥–æ –≤ —Ç–æ—Ç –¥–µ–Ω—å –±—ã–ª–æ —Å–æ–≤–µ—Ä—à–µ–Ω–æ 4 –ø–æ–ª–µ—Ç–∞, —Å–∞–º—ã–π –¥–ª–∏–Ω–Ω—ã–π –ø—Ä–æ–¥–æ–ª–∂–∞–ª—Å—è 59 —Å–µ–∫—É–Ω–¥.\n\n#–∞–≤–∏–∞—Ü–∏—è #–†–∞–π—Ç #–ø–µ—Ä–≤—ã–π_–ø–æ–ª–µ—Ç #–∏—Å—Ç–æ—Ä–∏—è #—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏",
                'category': 'aviation',
                'url': '',
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—É—é —Å—Å—ã–ª–∫—É –ò–õ–ò fallback
                'image_url': self.get_reliable_image_url('aviation'),
                'found_date': datetime.now()
            },
            {
                'title': '–ü–µ—Ä–≤—ã–π –∫–æ–º–ø—å—é—Ç–µ—Ä',
                'summary': "üíª –ü–ï–†–í–´–ô –≠–õ–ï–ö–¢–†–û–ù–ù–´–ô –ö–û–ú–ü–¨–Æ–¢–ï–†\n\nENIAC (Electronic Numerical Integrator and Computer), —Å–æ–∑–¥–∞–Ω–Ω—ã–π –≤ 1946 –≥–æ–¥—É, —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–µ—Ä–≤—ã–º —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–º –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–º –æ–±—â–µ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è.\n\n‚Ä¢ –ì–æ–¥ —Å–æ–∑–¥–∞–Ω–∏—è: 1946\n‚Ä¢ –í–µ—Å: 27 —Ç–æ–Ω–Ω\n‚Ä¢ –ü–ª–æ—â–∞–¥—å: 167 –º¬≤\n‚Ä¢ –ü—Ä–æ—Ü–µ—Å—Å–æ—Ä–æ–≤: 17 468 –ª–∞–º–ø\n\n‚ö° ENIAC –º–æ–≥ –≤—ã–ø–æ–ª–Ω—è—Ç—å 5000 –æ–ø–µ—Ä–∞—Ü–∏–π —Å–ª–æ–∂–µ–Ω–∏—è –≤ —Å–µ–∫—É–Ω–¥—É. –ï–≥–æ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª–æ–∂–∏–ª–æ –Ω–∞—á–∞–ª–æ –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–π —Ä–µ–≤–æ–ª—é—Ü–∏–∏ –∏ —Å—Ç–∞–ª–æ –æ—Å–Ω–æ–≤–æ–π –¥–ª—è –≤—Å–µ—Ö —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–∏—Å—Ç–µ–º.\n\n#–∫–æ–º–ø—å—é—Ç–µ—Ä #—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ #–∏—Å—Ç–æ—Ä–∏—è #ENIAC",
                'category': 'computers',
                'url': '',
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—É—é —Å—Å—ã–ª–∫—É –ò–õ–ò fallback
                'image_url': self.get_reliable_image_url('computers'),
                'found_date': datetime.now()
            }
        ]
        
        return random.sample(quality_posts, 3)

    def get_reliable_image_url(self, category):
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —Ä–∞–±–æ—Ç–∞—é—â—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"""
        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º —Ä–∞–±–æ—á–∏–µ Wikimedia –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        if self.working_wikimedia_images:
            image_url = random.choice(self.working_wikimedia_images)
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å—Å—ã–ª–∫–∞ —Ä–∞–±–æ—á–∞—è
            if self.test_image_url(image_url):
                return image_url
        
        # –ï—Å–ª–∏ Wikimedia –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º Unsplash
        return self.unsplash_images.get(category, self.unsplash_images['default'])

    def test_image_url(self, url):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ —Å—Å—ã–ª–∫–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–∞–±–æ—á–∞—è"""
        try:
            response = requests.head(url, timeout=5)
            return response.status_code == 200
        except:
            return False

    def is_relevant_content(self, text):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞"""
        keywords = [
            '–ø–µ—Ä–≤—ã–π', '–ø–µ—Ä–≤–æ–µ', '–∏–∑–æ–±—Ä–µ—Ç–µ–Ω–∏–µ', '–æ—Ç–∫—Ä—ã—Ç–∏–µ', '—Ä–µ–≤–æ–ª—é—Ü–∏—è',
            '–ø—Ä–æ—Ä—ã–≤', '—Ä–µ–∫–æ—Ä–¥', '–∏—Å—Ç–æ—Ä–∏—è', '—Å–æ–∑–¥–∞–Ω', '—Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω',
            '–∑–∞–ø—É—â–µ–Ω', '–æ–±–Ω–∞—Ä—É–∂–µ–Ω', '–Ω–∞—É—á–Ω—ã–π', '—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è'
        ]
        text_lower = text.lower()
        return any(keyword in text_lower for keyword in keywords)

    def format_for_preview(self, content):
        """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞"""
        current_time = datetime.now()
        preview_text = f"üì∞ –ü–†–ï–î–ü–†–û–°–ú–û–¢–† –ü–û–°–¢–ê\n\n{content['summary']}\n\n"
        
        if content.get('image_url'):
            preview_text += f"üñºÔ∏è –ï—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ\n\n"
        
        preview_text += f"‚è∞ –ù–∞–π–¥–µ–Ω–æ: {current_time.strftime('%H:%M %d.%m.%Y')}"
        
        return preview_text

def setup_content_finder():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –ø–æ–∏—Å–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞"""
    return ContentFinder()
